@extends('layouts.app')

@section('title', 'Daftar Lahan')

@section('styles')
<style>
    #map {
        height: 400px;
        width: 100%;
        margin-bottom: 20px;
    }
    .legend {
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
    }
    .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.7;
    }
    .legend .circle {
        border-radius: 50%;
        width: 12px;
        height: 12px;
        margin-top: 3px;
    }
</style>
<!-- Add Leaflet.draw CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
@endsection

@section('content')
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Daftar Lahan Pertanian</h2>
        <a href="{{ route('lahans.create') }}" class="btn btn-success">
            <i class="bi bi-plus-circle"></i> Tambah Lahan
        </a>
    </div>

    <div id="map"></div>

    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Pemilik</th>
                    <th>Luas (m²)</th>
                    <th>Lokasi</th>
                    <th>Keterangan</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody>
                @forelse($lahans as $lahan)
                <tr>
                    <td>{{ $loop->iteration }}</td>
                    <td>{{ $lahan->pemilik }}</td>
                    <td>{{ $lahan->luas }}</td>
                    <td>{{ $lahan->lokasi }}</td>
                    <td>{{ $lahan->keterangan ?? '-' }}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <a href="{{ route('lahans.show', $lahan) }}" class="btn btn-info btn-sm">Detail</a>
                            <a href="{{ route('lahans.edit', $lahan) }}" class="btn btn-warning btn-sm">Edit</a>
                            <form action="{{ route('lahans.destroy', $lahan) }}" method="POST" class="d-inline">
                                @csrf
                                @method('DELETE')
                                <button type="submit" class="btn btn-danger btn-sm" 
                                    onclick="return confirm('Yakin ingin menghapus data ini?')">Hapus</button>
                            </form>
                        </div>
                    </td>
                </tr>
                @empty
                <tr>
                    <td colspan="6" class="text-center">Tidak ada data lahan</td>
                </tr>
                @endforelse
            </tbody>
        </table>
    </div>

    <div class="d-flex justify-content-center">
        {{ $lahans->links() }}
    </div>
</div>
@endsection

@section('scripts')
<!-- Add Leaflet.draw JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<script>
    // Inisialisasi peta dengan fokus ke Desa Ngasem
    const map = L.map('map').setView([-6.6540405, 110.7196520], 14.5);

    // Layer OpenStreetMap
    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    });

    // Layer Google Satellite
    const googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3'],
        attribution: '© Google'
    });

    // Layer Google Hybrid
    const googleHybrid = L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3'],
        attribution: '© Google'
    });

    // Base layers
    const baseLayers = {
        "OpenStreetMap": osmLayer,
        "Satelit": googleSat,
        "Hybrid": googleHybrid
    };

    // Set default layer
    osmLayer.addTo(map);

    // Tambahkan control layer
    L.control.layers(baseLayers).addTo(map);

    // Koordinat batas Desa Ngasem
    const ngasemCoordinates = [
        [ 110.71731535203304, -6.636650443028777 ], [ 110.723504476017951, -6.638593540093805 ], [ 110.726760962765823, -6.639798979939702 ], [ 110.726760962765823, -6.639798979939702 ], [ 110.726976862439713, -6.641850026841676 ], [ 110.726976862439713, -6.641850026841676 ], [ 110.727336695229525, -6.642371784386915 ], [ 110.727894436053745, -6.64228182618946 ], [ 110.727858452774768, -6.641904001760149 ], [ 110.727678536379855, -6.641634127167784 ], [ 110.727678536379855, -6.641328269296437 ], [ 110.728128327367131, -6.641472202412365 ], [ 110.728470168517461, -6.641292286017455 ], [ 110.728470168517461, -6.641292286017455 ], [ 110.729027909341681, -6.64102241142509 ], [ 110.729423725410484, -6.640968436506617 ], [ 110.729387742131507, -6.641346260935928 ], [ 110.729351758852516, -6.641634127167784 ], [ 110.729603641805397, -6.641724085365239 ], [ 110.729909499676751, -6.641598143888802 ], [ 110.730413265582499, -6.641490194051856 ], [ 110.730791090011806, -6.64138224421491 ], [ 110.731024981325191, -6.641598143888802 ], [ 110.7309889980462, -6.642011951597095 ], [ 110.731294855917554, -6.641724085365239 ], [ 110.731672680346861, -6.641292286017455 ], [ 110.731996529857696, -6.641580152249311 ], [ 110.73242832920549, -6.641634127167784 ], [ 110.732734187076829, -6.641886010120658 ], [ 110.732734187076829, -6.642155884713023 ], [ 110.732824145274279, -6.642443750944879 ], [ 110.733147994785128, -6.642155884713023 ], [ 110.733399877737995, -6.641760068644221 ], [ 110.733327911180041, -6.641418227493892 ], [ 110.733147994785128, -6.641112369622545 ], [ 110.733471844295963, -6.640950444867125 ], [ 110.733525819214435, -6.640392704042905 ], [ 110.733741718888325, -6.64012282945054 ], [ 110.734463843863281, -6.640579608095785 ], [ 110.734663237317463, -6.640915428650201 ], [ 110.734930844321767, -6.640957406219503 ], [ 110.735250923287694, -6.641482125835777 ], [ 110.735702182157695, -6.641555586582056 ], [ 110.736442036816641, -6.641151552477525 ], [ 110.736741126997913, -6.640296259502997 ], [ 110.736447284012797, -6.640196562775905 ], [ 110.736394812051174, -6.640044394087185 ], [ 110.736494508778264, -6.639782034279047 ], [ 110.736772610174896, -6.639524921667073 ], [ 110.737311961029349, -6.639837836331888 ], [ 110.737914528219832, -6.640201454464076 ], [ 110.738184644546607, -6.639962505405781 ], [ 110.738382037246936, -6.639848225421379 ], [ 110.738662542663192, -6.639993672674255 ], [ 110.739181997137749, -6.640367679895933 ], [ 110.739659895254334, -6.640388458074915 ], [ 110.739930011581109, -6.640191065374585 ], [ 110.739898844312634, -6.639900170868835 ], [ 110.740179349728891, -6.639869003600362 ], [ 110.740740683826303, -6.639419130353136 ], [ 110.740894532159743, -6.639478960260582 ], [ 110.741262058734051, -6.640085806464677 ], [ 110.741774886512161, -6.640162730631394 ], [ 110.741928734845601, -6.640325126094461 ], [ 110.741962923364142, -6.64053880433534 ], [ 110.74189454632706, -6.640726841187313 ], [ 110.742039847530847, -6.640863595261475 ], [ 110.741997111882682, -6.641025990724542 ], [ 110.741952825072048, -6.641186372823605 ], [ 110.741997574084223, -6.641298245354057 ], [ 110.742101988445981, -6.641376556125373 ], [ 110.742157924711208, -6.641380285209721 ], [ 110.742087072108589, -6.641641321114109 ], [ 110.742083343024234, -6.641879982512407 ], [ 110.742034864927703, -6.642096269404614 ], [ 110.742057239433805, -6.642491552345543 ], [ 110.742062802071501, -6.643094419368279 ], [ 110.741890680672853, -6.644609087676352 ], [ 110.742510317707982, -6.644884481914184 ], [ 110.742854560505265, -6.645159876152015 ], [ 110.742854560505265, -6.64598605886551 ], [ 110.742579166267433, -6.647053211537107 ], [ 110.74223492347015, -6.648051515649247 ], [ 110.741993953512036, -6.649084244041116 ], [ 110.741993953512036, -6.649635032516779 ], [ 110.742303772029601, -6.650151396712713 ], [ 110.7427857119458, -6.650771033747835 ], [ 110.743129954743097, -6.651425095062685 ], [ 110.743577470379577, -6.652148004936992 ], [ 110.743646318939028, -6.65256109629374 ], [ 110.743887288897128, -6.652767641972113 ], [ 110.743887288897128, -6.653077460489674 ], [ 110.744162683134959, -6.653284006168048 ], [ 110.743990561736325, -6.653903643203169 ], [ 110.744059410295776, -6.654420007399103 ], [ 110.743852864617409, -6.655659281469345 ], [ 110.743784016057944, -6.656037948546363 ], [ 110.741925104952585, -6.656210069945008 ], [ 110.741925104952585, -6.656210069945008 ], [ 110.740031769567494, -6.656692009861213 ], [ 110.739136738294533, -6.656967404099045 ], [ 110.738723646937785, -6.657552616854437 ], [ 110.738379404140503, -6.657621465413895 ], [ 110.738000737063487, -6.657690313973353 ], [ 110.737725342825655, -6.65744934401525 ], [ 110.737690918545923, -6.657690313973353 ], [ 110.73765649426619, -6.658309951008474 ], [ 110.737071281510808, -6.658860739484137 ], [ 110.736313947356763, -6.659342679400342 ], [ 110.736141825958114, -6.659790195036818 ], [ 110.736417220195946, -6.659962316435463 ], [ 110.735866431720282, -6.661063893386789 ], [ 110.73559103748245, -6.661339287624621 ], [ 110.735315643244618, -6.661167166225976 ], [ 110.734489460531137, -6.661270439065163 ], [ 110.734420611971672, -6.661580257582723 ], [ 110.734386187691939, -6.661855651820555 ], [ 110.734282914852756, -6.662234318897573 ], [ 110.733835399216275, -6.662131046058387 ], [ 110.733491156418992, -6.661752378981368 ], [ 110.733353459300076, -6.661339287624621 ], [ 110.732251882348748, -6.661614681862452 ], [ 110.731838790992001, -6.661545833302994 ], [ 110.731735518152817, -6.661924500380013 ], [ 110.731528972474436, -6.66233759173676 ], [ 110.731012608278505, -6.662303167457031 ], [ 110.73070278976094, -6.661958924659742 ], [ 110.730220849844741, -6.661786803261097 ], [ 110.729601212809627, -6.662062197498929 ], [ 110.729291394292062, -6.662096621778658 ], [ 110.728809454375849, -6.662199894617844 ], [ 110.728534060138017, -6.661993348939471 ], [ 110.728534060138017, -6.661786803261097 ], [ 110.728224241620467, -6.661614681862452 ], [ 110.727948847382635, -6.661855651820555 ], [ 110.728086544501551, -6.662268743177302 ], [ 110.728017695942086, -6.662785107373237 ], [ 110.727707877424521, -6.662819531652965 ], [ 110.727570180305605, -6.662957228771881 ], [ 110.727225937508322, -6.662819531652965 ], [ 110.72695054327049, -6.662716258813779 ], [ 110.726812846151574, -6.662888380212423 ], [ 110.726847270431307, -6.663370320128629 ], [ 110.728052120221818, -6.663817835765105 ], [ 110.72856848441775, -6.664678442758328 ], [ 110.729532364250161, -6.665539049751552 ], [ 110.730461819802841, -6.665986565388028 ], [ 110.729084848613681, -6.667604506535289 ], [ 110.72856848441775, -6.667742203654205 ], [ 110.724988359325934, -6.664747291317786 ], [ 110.725917814878628, -6.663714562925918 ], [ 110.725573572081331, -6.663267047289442 ], [ 110.725263753563766, -6.663473592967815 ], [ 110.724781813647567, -6.663783411485376 ], [ 110.723611388136788, -6.665057109835347 ], [ 110.723370418178675, -6.665332504073178 ], [ 110.723060599661125, -6.665366928352907 ], [ 110.721752477031416, -6.666227535346131 ], [ 110.721580355632781, -6.666606202423149 ], [ 110.721167264276033, -6.666812748101523 ], [ 110.719962414485508, -6.666881596660981 ], [ 110.719652595967958, -6.66787990077312 ], [ 110.712595618623524, -6.663852260044834 ], [ 110.71273331574244, -6.663129350170526 ], [ 110.713490649896471, -6.662612985974592 ], [ 110.713938165532952, -6.662888380212423 ], [ 110.714454529728883, -6.662062197498929 ], [ 110.715039742484279, -6.661545833302994 ], [ 110.715556106680211, -6.660788499148958 ], [ 110.715900349477494, -6.660272134953023 ], [ 110.715900349477494, -6.65972134647736 ], [ 110.71442010544915, -6.652457823454553 ], [ 110.71442010544915, -6.652457823454553 ], [ 110.714247984050516, -6.651080852265395 ], [ 110.714867621085631, -6.649669456796508 ], [ 110.714833196805898, -6.649118668320845 ], [ 110.714342525702079, -6.648533966105526 ], [ 110.714404973375053, -6.647316236482461 ], [ 110.71574759834408, -6.643631823776778 ], [ 110.715841269853541, -6.642070631952336 ], [ 110.71731535203304, -6.636650443028777 ]
    ];

    // Inisialisasi FeatureGroup untuk menyimpan layer yang dapat diedit
    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    // Inisialisasi kontrol Leaflet.draw
    const drawControl = new L.Control.Draw({
        draw: {
            polygon: {
                allowIntersection: false,
                showArea: true
            },
            circle: false,
            circlemarker: false,
            rectangle: false,
            polyline: false,
            marker: false
        },
        edit: {
            featureGroup: drawnItems,
            remove: true
        }
    });
    map.addControl(drawControl);

    // Event handler untuk menyimpan polygon yang digambar
    map.on('draw:created', function(e) {
        const layer = e.layer;
        drawnItems.addLayer(layer);
        
        // Dapatkan koordinat polygon
        const coordinates = layer.getLatLngs()[0].map(coord => [coord.lng, coord.lat]);
        console.log('Koordinat Polygon:', coordinates);
    });

    // Tambahkan polygon Desa Ngasem yang sudah ada
    const ngasemPolygon = L.polygon(ngasemCoordinates.map(coord => [coord[1], coord[0]]), {
        color: 'green',
        weight: 2,
        fillColor: 'green',
        fillOpacity: 0.5,
        dashArray: '5, 10'
    }).addTo(map);

    // Set view ke batas polygon
    map.fitBounds(ngasemPolygon.getBounds());

    // Tambahkan marker untuk setiap lahan
    @foreach($lahans as $lahan)
        L.marker([{{ $lahan->latitude }}, {{ $lahan->longitude }}])
            .bindPopup(`
                <b>Pemilik: {{ $lahan->pemilik }}</b><br>
                Luas: {{ $lahan->luas }} m²<br>
                Lokasi: {{ $lahan->lokasi }}<br>
                Keterangan: {{ $lahan->keterangan ?? '-' }}
            `)
            .addTo(map);
    @endforeach
</script>
@endsection 